<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="shiwi"><meta name="copyright" content="SHIWIVI"><link rel="shortcut icon" href="/blog/images/favicon.ico" type="image/x-icon"><style>.preload{position:absolute;display:flex;flex-direction:column;align-items:center;justify-content:center;left:0;top:0;width:100%;height:100%;background-color:#000;z-index:100}.text{margin-bottom:10px;color:#00cff3;text-shadow:0 0 3px #00cff3;font-size:20px}.text span{display:inline-block}.dance{animation:dance .8s linear}.text span:nth-child(1){animation-delay:0s}.text span:nth-child(2){animation-delay:.1s}.text span:nth-child(3){animation-delay:.2s}.text span:nth-child(4){animation-delay:.3s}.text span:nth-child(5){animation-delay:.4s}.text span:nth-child(6){animation-delay:.5s}.text span:nth-child(7){animation-delay:.6s}.text span:nth-child(8){animation-delay:.7s}.text span:nth-child(9){animation-delay:.8s}.text span:nth-child(10){animation-delay:.9s}@keyframes dance{0%{transform:translateY(0)}50%{transform:translateY(-20px)}100%{transform:translateY(0)}}.loading{width:80%;max-width:260px;height:6px;background-color:#e1e4e8;border-radius:6px}.bar{display:flex;height:100%;background:linear-gradient(90deg,#ffd33d,#ea4aaa 10%,#b34bff 30%,#01feff 51%,#ffb33d 68%,#ea4aaa 85%,#b34bff);background-size:300% 100%;animation:bar 2s linear infinite}@keyframes bar{0%{background-position:100%}100%{background-position:0}}</style><body><div class="preload"><div class="text"><span>L</span> <span>o</span> <span>a</span> <span>d</span> <span>i</span> <span>n</span> <span>g</span> <span>.</span> <span>.</span> <span>.</span></div><div class="loading"><span class="bar"></span></div></div><script>let texts=document.querySelector('.text').querySelectorAll('span');let timer=setInterval(()=>{texts.forEach((item)=>{item.classList.toggle("dance")})},1700);window.onload=function(){clearInterval(timer);document.querySelector('.preload').style="display:none;"}</script><title>SHIWIVI-文章</title>
<link rel="stylesheet" href="https://at.alicdn.com/t/font_2856826_bu73u0ahu7a.css">

<link rel="stylesheet" href="/blog/css/index.css">
<link rel="stylesheet" href="/blog/css/article.css">
<link rel="stylesheet" href="/blog/css/atelier-cave.min.css">

<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/blog/atom.xml" title="SHWIVI's blog" type="application/atom+xml">
</head>
<body>
<div class="nav">
    <div class="card">
        <div class="head">
            <img src="/blog/images/head.jpg"  alt="头不见了.." title="狗">
        </div>
        <div class="card-text">
            <p>(ー`´ー)</p>
            <p>那不是bug，是彩蛋</p>
        </div> 
    </div>
    <ul class="label">
        
        <li><a href="/blog/index.html">首页</a></li>
        
        <li><a href="/blog/life">日常</a></li>
        
        <li><a href="/blog/record">一句</a></li>
        
        <li><a href="/blog/message">留言</a></li>
        
        <li><a href="/blog/about">关于</a></li>
          
    </ul>
        <ul class="tag">
            <li><a href="/blog/tags/Command">#Command</a></li>
            <li>#Java</li>
            <li><a href="/blog/tags/Css">#Css</a></li>
            <li><a href="/blog/tags/Life">#Life</a></li>
            <li>#Lua</li>
            <li><a href="/blog/tags/PCB">#PCB</a></li>
            <li><a href="/blog/tags/Shell">#Shell</a></li>
            <li><a href="/blog/tags/C">#C</a></li>
            <li><a href="/blog/tags/html">#html</a></li>
            <li><a href="/blog/tags/%E7%A1%AC%E4%BB%B6">#硬件</a></li>
            <li><a href="/blog/tags/JavaScrip">#JavaScript</a></li>
            <li><a href="/blog/tags/Firewall">#Firewall</a></li>
            <li>#Security</li>
            <li><a href="/blog/tags/Linux">#Linux</a></li>
            <li>#Python</li>
            <li><a href="/blog/tags/Server">#Server</a></li>
            <li><a href="/blog/tags/Web">#Web</a></li>
        </ul>
    <div class="rsstag"><a href="/blog/atom.xml"><span class="iconfont icon-rss"></span>RSS订阅</a></div>
<div class="flower">
<?xml version="1.0" encoding="UTF-8"?>
<svg width="84.6px" height="70.5px" viewBox="0 0 254 212" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<title>窗</title>
<desc>Created with Sketch.</desc>
<defs></defs>
<g id="植物" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
    <g id="Artboard" transform="translate(-885.000000, -503.000000)">
        <g id="植物-紫色盆" transform="translate(882.000000, 500.000000)">
            <ellipse id="Oval-12" fill="#B3B7C7" cx="140.5" cy="137" rx="39.5" ry="6"></ellipse>
            <g id="Group-5">
                <path d="M131.5,149 C137.746054,149 138.400559,136.953074 140.297813,118.503702 C141.504079,106.77367 149.145158,88.1140929 147,75 C142.297813,46.2539062 153.271934,32.5660626 150.170125,19.4282488 C148.031314,10.3692495 142.862042,3 131.5,3 C123.603887,3 113.698654,6.59314895 110.722909,11.2157433 C103.206874,22.8913341 114,46.5137576 114,75 C114,90.4435309 122.495151,106.751425 123.699377,118.476362 C125.595832,136.941172 125.250862,149 131.5,149 Z" id="Oval-11" fill="#BAC4F6"></path>
                <path d="M135.5,146.5 C132.598908,121.877878 130.965369,104.566553 130.599381,94.5660242 C130.050399,79.5652312 132.963841,77.0580598 132.164069,55.3464601 C131.630888,40.8720602 130.242865,30.4232402 128,24" id="Line-15" stroke="#FFFFFF" stroke-width="2" opacity="0.800892857" stroke-linecap="square"></path>
                <path d="M77.0442201,163.336077 C84.2239219,163.336077 101.067658,131.237823 101.067658,92.025606 C101.067658,52.8133888 90.9057581,-2.32627732 72.6560979,17.2440872 C50.0508064,41.4852946 69.5871262,36.5862429 74.0442201,63.8595149 C75.572858,73.2133576 77.0442201,94.5993942 77.0442201,104.613421 C77.0442201,143.825638 69.8645184,163.336077 77.0442201,163.336077 Z" id="Oval-9" fill="#BAC4F6" transform="translate(81.510722, 88.251316) rotate(-43.000000) translate(-81.510722, -88.251316) "></path>
                <path d="M42.5,50.5 C47.5132933,48.8699207 59.3816332,57.6317857 78.1050199,76.785595 C96.8284065,95.9394043 113.960067,116.844206 129.5,139.5" id="Line-17" stroke="#FFFFFF" stroke-width="2" stroke-linecap="square"></path>
                <path d="M155.281006,152.144255 C162.116643,152.144255 178.153197,121.584207 178.153197,84.2511084 C178.153197,72.6051871 184.354199,51.8242671 182.531201,39.8465879 C178.51025,13.4276595 163.058175,0.233079666 151.10317,13.0532528 C129.581164,36.1327785 143.297279,29.7382802 147.540781,55.7045685 C148.996164,64.6101585 153.500382,80.3852665 153.500382,89.9194035 C153.500382,127.252502 148.445368,152.144255 155.281006,152.144255 Z" id="Oval-9-Copy-2" fill="#E9EDFD" transform="translate(161.092971, 80.123972) scale(-1, 1) rotate(-20.000000) translate(-161.092971, -80.123972) "></path>
                <path d="M180.5,34.5 C181.290102,21.4892162 175.746138,28.9223292 163.868108,56.7993391 C157.546037,71.6368512 150.532373,85.3308057 144.827114,101.881203 C141.023608,112.914801 138.581237,128.787733 137.5,149.5" id="Line-20" stroke="#FFFFFF" stroke-width="2" stroke-linecap="square"></path>
                <path d="M60.3426107,183.894782 C69.2498271,183.894782 90.1463498,156.072081 90.1463498,122.083011 C90.1463498,88.0939419 67.5408019,29.4364067 54.8986583,57.2625442 C45.0326912,78.978146 51.0912584,74.0282851 56.6207779,97.6687014 C58.5172227,105.776593 67.8616068,124.363423 67.8616068,133.043561 C67.8616068,167.032631 51.4353942,183.894782 60.3426107,183.894782 Z" id="Oval-9-Copy" fill="#BAC4F6" transform="translate(69.895982, 116.944107) rotate(-71.000000) translate(-69.895982, -116.944107) "></path>
                <path d="M24.5,109.5 C22.4991751,103.669523 35.0833631,105.49608 62.2525641,114.979669 C79.4278854,120.974828 92.103247,119.378882 106.278649,126.191831 C111.777518,128.834684 120.517968,134.937407 132.5,144.5" id="Line-19" stroke="#FFFFFF" stroke-width="2" opacity="0.595424107" stroke-linecap="square"></path>
                <path d="M169.495543,159.559977 C178.40276,159.559977 199.299282,131.737276 199.299282,97.7482062 C199.299282,85.7856682 202.004463,66.329956 197.824033,53.1018748 C190.126639,28.745108 172.2443,14.8950801 164.051591,32.9277389 C154.185624,54.6433407 160.244191,49.6934798 165.77371,73.3338961 C167.670155,81.4417878 177.014539,100.028618 177.014539,108.708756 C177.014539,142.697825 160.588327,159.559977 169.495543,159.559977 Z" id="Oval-9-Copy-3" fill="#BAC4F6" transform="translate(179.479352, 92.134636) scale(-1, 1) rotate(-43.000000) translate(-179.479352, -92.134636) "></path>
                <path d="M213.5,60.5 C209.183273,60.8948914 201.740861,65.4428024 191.172763,74.1437328 C175.320617,87.1951284 177.797205,83.2393994 161.560337,103.262986 C150.735758,116.612043 142.715646,131.024381 137.5,146.5" id="Line-21" stroke="#FFFFFF" stroke-width="2" stroke-linecap="square"></path>
                <path d="M81.1425752,168.630026 C85.1025169,165.536181 98.2051544,147.96348 98.2051544,111.236918 C98.2051544,74.5103552 86.0176544,46.7369177 70.0176544,46.7369177 C54.0176544,46.7369177 59.5351666,70.3889964 66.8400325,93.0530589 C69.6371249,101.731312 78.9791535,122.814465 81.0032985,132.88325 C84.2653955,149.110029 78.6989273,170.539213 81.1425752,168.630026 Z" id="Oval-10" fill="#E9EDFD" transform="translate(78.936475, 107.743055) rotate(-52.000000) translate(-78.936475, -107.743055) "></path>
                <path d="M39.5,84.5 C46.5402399,84.832105 55.9862242,87.7506309 67.8379528,93.2555776 C85.6155457,101.512998 79.9127462,96.6348296 100.298442,112.739947 C113.888906,123.476691 125.956092,135.063376 136.5,147.5" id="Line-18" stroke="#FFFFFF" stroke-width="2" stroke-linecap="square"></path>
                <path d="M194.823347,177.534556 C197.785465,175.220296 209.085075,165.125173 213.530819,146.109724 C215.496552,137.701844 211.555235,124.000271 211.555235,111.853141 C211.555235,72.2337887 199.639103,43.8487815 182.378853,43.8487815 C165.118604,43.8487815 168.053621,58.2764613 175.933859,82.7256721 C183.814096,107.174883 191.693317,118.61017 193.876895,129.472028 C197.395933,146.976919 192.187224,179.594121 194.823347,177.534556 Z" id="Oval-10-Copy-2" fill="#E9EDFD" transform="translate(191.881132, 110.738214) scale(-1, 1) rotate(-52.000000) translate(-191.881132, -110.738214) "></path>
                <path d="M237.5,84.5 C231.839918,82.6252532 222.387737,84.7837206 209.143456,90.9754021 C189.277034,100.262925 198.344222,96.9653923 174.587666,113.911421 C158.749962,125.208774 147.387407,137.071634 140.5,149.5" id="Line-22" stroke="#FFFFFF" stroke-width="2" opacity="0.785044643" stroke-linecap="square"></path>
                <path d="M102.095097,154.049614 C106.979303,150.233654 123.140143,128.559423 123.140143,83.2607523 C123.140143,37.9620813 108.108037,3.70622602 88.3735811,3.70622602 C68.639125,3.70622602 75.4444439,32.8787829 84.4542911,60.8327171 C87.9042347,71.5365054 99.4267255,97.5405402 101.923313,109.959415 C105.946795,129.97358 99.0810936,156.404412 102.095097,154.049614 Z" id="Oval-10-Copy" fill="#E9EDFD" transform="translate(99.374086, 78.951409) rotate(-21.000000) translate(-99.374086, -78.951409) "></path>
                <path d="M70.5,27.5 C77.9697854,36.2141564 84.664658,44.2949462 90.5846178,51.7423694 C99.4645574,62.9135043 102.309139,65.8595669 108.078018,74.773869 C113.846897,83.6881711 108.232283,69.1486166 118.500716,94.8794382 C125.346337,112.033319 129.012765,128.573507 129.5,144.5" id="Line-16" stroke="#FFFFFF" stroke-width="2" stroke-linecap="square"></path>
                <path d="M193.001521,189.153265 C198.929205,189.153265 212.83568,162.652399 212.83568,130.278124 C212.83568,97.9038493 204.210737,49.7003434 189.378612,68.5372278 C174.540517,87.3816949 180.150684,86.5530431 183.830536,109.070321 C185.092606,116.793013 193.001521,132.403088 193.001521,140.670839 C193.001521,173.045114 187.073837,189.153265 193.001521,189.153265 Z" id="Oval-9-Copy-4" fill="#BAC4F6" transform="translate(196.248002, 126.727326) scale(-1, 1) rotate(-73.000000) translate(-196.248002, -126.727326) "></path>
                <path d="M234.5,116.5 C229.435614,115.997419 220.043174,117.148484 206.322678,119.953197 C185.741934,124.160265 185.201799,123.9696 168.145826,131.063968 C156.775178,135.793546 148.226569,140.93889 142.5,146.5" id="Line-23" stroke="#FFFFFF" stroke-width="2" opacity="0.733426339" stroke-linecap="square"></path>
            </g>
            <g id="Group-4" transform="translate(101.000000, 137.000000)">
                <path d="M0,0 C11.7955729,2 24.5052083,3 38.1289062,3 C51.7526042,3 65.3763021,2 79,0 L71.2109375,75.3409091 C61.9375,77.1136364 51.8945312,78 41.0820312,78 C30.2695313,78 19.4570312,77.1136364 8.64453125,75.3409091 L0,0 Z" id="Rectangle-9" fill="#FCDCCF"></path>
                <path d="M59.2621996,2.19791001 C63.6483775,1.86496527 70.2276443,1.1323286 79,0 L71.2109375,75.3409091 C63.3055851,76.5844933 57.2271178,77.3450382 52.9755357,77.6225437 L59.2621996,2.19791001 Z" id="Rectangle-9" fill="#ECC6B6"></path>
                <path d="M0,0 C10.9588352,1.33333333 23.3572727,2 37.1953125,2 C51.0333523,2 64.9682481,1.33333333 79,0 L76.7909585,21.3672948 L40.573652,23.0934676 L2.38711382,20.8047516 L0,0 Z" id="Rectangle-9" fill="#F3B096"></path>
            </g>
        </g>
    </g>
</g>
</svg>
</div>

</div>
<div class="menu-btn closed"> 
    <div class="menu-line"></div>
    <div class="menu-line"></div>
    <div class="menu-line"></div>
</div>
<div class="main">
    <div class="msg">
        <div class="msg-text"></div>
        <div class="msg-bar"></div>
    </div>
    <div class="motto">
        <p> //sunny forever<br />
            while(life&lt;end){<br />
               love++;<br />
               beAwesome :)} </p>
     </div>
     <div class="main-content">
    <div class="set-wrapper">
    <ul class="set-menu">
        <div id="set-btn" class="set-button"><</div>
        <li class="search-container">
            <input id="search-input" class="local-search" placeholder="搜索..." type="search" >
            <span class="search-ico"></span>
        </li>
        <li id="toggle-theme">
        主题：<span class="theme-ico sun"></span>
        </li>
        <li class="set-size">
            <span id="increase-font-size">+</span>
            <span class="font-size-num"></span>
            <span id="reduce-font-size">-</span>
        </li>
        <li id="clear-back">清除背景</li>
        <li id="disable-back">禁用背景</li>
    </ul> 
</div>
    <div class="result-container">
        <div id="search-result" class="display-result"></div>
    </div>
    <div class="toc-wrapper"><div class="toc-btn">目 录</div><div class="toc-box"><!--tocBox用于容纳生成在toc外的目录--><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E"><span class="toc-number">1.</span> <span class="toc-text">关于</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Let%E2%80%99s-Encrypt"><span class="toc-number">1.1.</span> <span class="toc-text">Let’s Encrypt</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ISRG"><span class="toc-number">1.2.</span> <span class="toc-text">ISRG</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Certbot"><span class="toc-number">1.3.</span> <span class="toc-text">Certbot</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E9%9C%80%E8%A6%81"><span class="toc-number">2.</span> <span class="toc-text">前置需要</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85certbot"><span class="toc-number">3.</span> <span class="toc-text">安装certbot</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%98%E6%96%B9%E5%AE%89%E8%A3%85"><span class="toc-number">3.1.</span> <span class="toc-text">官方安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87pip3%E5%AE%89%E8%A3%85"><span class="toc-number">3.2.</span> <span class="toc-text">通过pip3安装</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#pip3%E7%89%88%E6%9C%AC%E8%BE%83%E4%BD%8E%E6%8A%A5%E9%94%99%E9%97%AE%E9%A2%98"><span class="toc-number">3.2.1.</span> <span class="toc-text">pip3版本较低报错问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%B3%E8%AF%B7%E8%AF%81%E4%B9%A6"><span class="toc-number">4.</span> <span class="toc-text">申请证书</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E5%9F%9F%E5%90%8D"><span class="toc-number">4.1.</span> <span class="toc-text">验证域名</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-Nginx"><span class="toc-number">4.1.1.</span> <span class="toc-text">1. Nginx</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-Apache"><span class="toc-number">4.1.2.</span> <span class="toc-text">2. Apache</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-Webroot%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.1.3.</span> <span class="toc-text">3. Webroot模式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-Standalone%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.1.4.</span> <span class="toc-text">3. Standalone模式</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%B3%E8%AF%B7%E6%B5%81%E7%A8%8B"><span class="toc-number">4.2.</span> <span class="toc-text">申请流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%92%E4%BB%B6%E6%9C%AA%E5%AE%89%E8%A3%85%E6%8A%A5%E9%94%99%E9%97%AE%E9%A2%98"><span class="toc-number">4.3.</span> <span class="toc-text">插件未安装报错问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#web%E6%9C%8D%E5%8A%A1%E6%97%A0%E6%B3%95%E6%89%BE%E5%88%B0%E6%8A%A5%E9%94%99%E9%97%AE%E9%A2%98"><span class="toc-number">4.4.</span> <span class="toc-text">web服务无法找到报错问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E8%AF%B4%E6%98%8E"><span class="toc-number">5.</span> <span class="toc-text">文件说明</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%86%E9%92%A5%E4%B8%8E%E8%AF%81%E4%B9%A6"><span class="toc-number">5.1.</span> <span class="toc-text">密钥与证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">5.2.</span> <span class="toc-text">通用配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%86%E9%92%A5%E4%BA%A4%E6%8D%A2"><span class="toc-number">5.3.</span> <span class="toc-text">密钥交换</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%86%E5%8F%B2%E6%96%87%E4%BB%B6"><span class="toc-number">5.4.</span> <span class="toc-text">历史文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6"><span class="toc-number">5.5.</span> <span class="toc-text">日志文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">6.</span> <span class="toc-text">Nginx配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">7.</span> <span class="toc-text">常用命令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%87%AA%E5%8A%A8%E7%BB%AD%E8%AE%A2"><span class="toc-number">7.1.</span> <span class="toc-text">测试自动续订</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8F%92%E4%BB%B6%E6%9C%AA%E5%AE%89%E8%A3%85%E6%8A%A5%E9%94%99"><span class="toc-number">7.1.1.</span> <span class="toc-text">插件未安装报错</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%AD%E8%AE%A2%E8%AF%81%E4%B9%A6"><span class="toc-number">7.2.</span> <span class="toc-text">续订证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E8%AF%81%E4%B9%A6%E5%88%97%E8%A1%A8"><span class="toc-number">7.3.</span> <span class="toc-text">查看证书列表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8A%E9%94%80%E4%B8%8E%E5%88%A0%E9%99%A4%E8%AF%81%E4%B9%A6"><span class="toc-number">7.4.</span> <span class="toc-text">吊销与删除证书</span></a></li></ol></li></ol></div></div>
        <div class="article">
        <h1 class="title">基于certbot获取TLS证书</h1>
        <div class="art-info">
            <div><span><span class="iconfont icon-zishu-jzl"></span>字数：8222</span>
            <span><span class="iconfont icon-riqi"></span>写于：2022-07-29</span></div>
            <div><span><span class="iconfont icon-zuixinnew3"></span>最新更新：2022-07-29</span>
            <span><span class="iconfont icon-shijian"></span>阅读本文预计花费您24分钟</span></div>
        </div>
        <div class="art-content">
        <div class="broadcast color-blue">
<div class="iconfont icon-yinhao"></div>
Let’s Encrypt 官网：<a target="_blank" rel="noopener" href="https://letsencrypt.org/">https://letsencrypt.org/</a></div>

<h3 id="关于"><a href="#关于" class="headerlink" title="关于"></a>关于</h3><h4 id="Let’s-Encrypt"><a href="#Let’s-Encrypt" class="headerlink" title="Let’s Encrypt"></a>Let’s Encrypt</h4><p>Let’s Encrypt 是由 ISRG (Internet Security Research Group)推出的免费安全证书计划，我们可以利用Let’s Encrypt 提供的TLS证书，在我们的网站上部署HTTPS 服务。</p>
<h4 id="ISRG"><a href="#ISRG" class="headerlink" title="ISRG"></a>ISRG</h4><p>ISRG（Internet Security Research Group ，互联网安全研究小组）是一个公益性的组织，该公益组织旨在减少资金、技术、教育障碍，以保护互联网上的通信，推动全球网站的HTTPS化。ISRG成立于2013 年 5 月，起初由Mozilla、电子前沿基金会(EFF)、密歇根大学、思科和 Akamai共同建立，后来又得了谷歌、亚马逊、讯飞、IBM、RedHat、Linux基金会等大厂商的赞助，所以他们的技术和证书安全是可以保障的。</p>
<h4 id="Certbot"><a href="#Certbot" class="headerlink" title="Certbot"></a>Certbot</h4><p>Certbot 是由电子前沿基金会 (EFF)制作的免费开源软件工具，用于在网站上申请、管理、使用由Let’s Encrypt颁发的证书，证书每60天更新一次。</p>
<h3 id="前置需要"><a href="#前置需要" class="headerlink" title="前置需要"></a>前置需要</h3><ul>
<li>一台可用的服务器，并拥有<span class="tips">root</span>权限</li>
<li>安装了Web服务，以<span class="tips">Nginx</span>为例</li>
<li>一个可用的域名，并解析到了该服务器上</li>
</ul>
<h3 id="安装certbot"><a href="#安装certbot" class="headerlink" title="安装certbot"></a>安装certbot</h3><h4 id="官方安装"><a href="#官方安装" class="headerlink" title="官方安装"></a>官方安装</h4><div class="broadcast color-yellow">
<div class="iconfont icon-dengpao14hao"></div>
certbot官方文档：<a target="_blank" rel="noopener" href="https://certbot.eff.org/">https://certbot.eff.org/</a></div>

<p>官网文档里给出了不同系统的详细安装方法，但在安装过程中会遇到不少问题，有些甚至涉及到需要重新编译Linux内核，这在已经部署业务的服务器上往往是无法实现的。</p>
<p>以CentOS7为例，根据官方的文档，安装Certbot需要先添加EPEL存储库，然后从中安装snapd软件包，但安装snapd需要解决诸多依赖问题：</p>
<ul>
<li>安装snapd需要Linux内核支持 SquashFS 文件系统</li>
<li>手动编译安装的SquashFS 文件系统，yum可能无法识别</li>
<li>内核编译时需要启用CONFIG_DEVPTS_MULTIPLE_INSTANCES 选项，如果没有需要重新编译内核</li>
</ul>
<h4 id="通过pip3安装"><a href="#通过pip3安装" class="headerlink" title="通过pip3安装"></a>通过pip3安装</h4><p>如果无法安装snapd，那只能绕过它，通过其他包管理工具安装，以pip（python包管理工具）为例</p>
<p>安装python并通过pip安装certbot</p>
<pre><code>yum install -y python3 && pip3 install certbot</code></pre>

<h5 id="pip3版本较低报错问题"><a href="#pip3版本较低报错问题" class="headerlink" title="pip3版本较低报错问题"></a>pip3版本较低报错问题</h5><p>在安装certbot时，如果yum源中的pip3版本较低，可能会导致模块导入失败，从而报错</p>
<div class="shell">Complete output from command python setup.py egg_info:
            =============================DEBUG ASSISTANCE==========================
            If you are seeing an error here please try the following to
            successfully install cryptography:
            Upgrade to the latest pip and try again. This will fix errors for most
            users. See: https://pip.pypa.io/en/stable/installing/#upgrading-pip
            =============================DEBUG ASSISTANCE==========================
    Traceback (most recent call last):
      File "&lt;string>", line 1, in &lt;module>
      File "/tmp/pip-build-2bwzqu_0/cryptography/setup.py", line 14, in &lt;module>
        from setuptools_rust import RustExtension
    ModuleNotFoundError: No module named 'setuptools_rust'
    ----------------------------------------
Command "python setup.py egg_info" failed with error code 1 in /tmp/pip-build-2bwzqu_0/cryptography/</div>

<p>此时根据报错提示，升级pip3到最新版本即可</p>
<pre><code>sudo pip3 install --upgrade pip</code></pre>

<p>升级完毕再安装certbot</p>
<pre><code>pip3 install certbot</code></pre>



<h3 id="申请证书"><a href="#申请证书" class="headerlink" title="申请证书"></a>申请证书</h3><h4 id="验证域名"><a href="#验证域名" class="headerlink" title="验证域名"></a>验证域名</h4><p>申请证书前，Let’s Encrypt需要先验证域名，以确认用户拥有对域名的控制权。验证通过后，certbot会立马进入申请流程，因此下述命令会同时验证域名和申请证书。certbot针对不同的web服务器和需求，有多种不同的验证方式：</p>
<h5 id="1-Nginx"><a href="#1-Nginx" class="headerlink" title="1. Nginx"></a>1. Nginx</h5><p>如果部署了Nginx，可以直接执行（但要确保安装了certbot-nginx插件）</p>
<pre><code>sudo certbot --nginx</code></pre>
<p>certbot将自动获取域名，并在进入证书申请流程时让你确认域名，也可以在执行上述命令时通过添加<span class="tips">-d</span>参数来指定域名，如：</p>
<div class="show"><code>sudo certbot -&zwnj;-nginx -d  shiwivi.com -d  www.shiwivi.com</code></div>

<p>可以通过<span class="tips">-&zwnj;-email</span>来添加邮箱，Let’s Encrypt会在证书即将到期时发邮件通知你更新证书。</p>
<div class="show"><code>sudo certbot -&zwnj;-nginx --email xxxx@gmail.com -d  shiwivi.com -d  www.shiwivi.com</code></div>

<p>如果不添加上述参数，certbot会在验证通过后要求你添加，邮箱一般只需要在首次验证证书或者更改邮箱时添加。</p>
<h5 id="2-Apache"><a href="#2-Apache" class="headerlink" title="2. Apache"></a>2. Apache</h5><p>Apache中的验证方法与上类似</p>
<pre><code>sudo certbot --apache</code></pre>

<h5 id="3-Webroot模式"><a href="#3-Webroot模式" class="headerlink" title="3. Webroot模式"></a>3. Webroot模式</h5><p>上述方法会重启我们的web服务以重新加载配置文件，如果我们希望在颁发证书时，不重启web服务，则可以使用webroot模式。webroot模式下，certbot 会利用已经部署的 web 服务，在其 web 服务根目录下创建名为<span class="tips">/.well-known/acme-challenge</span>的隐藏文件，然后由 Let’s Encrypt 服务端通过域名来访问该隐藏文件，从而完成验证。</p>
<p>因此，在执行命令时，我们需要添加<span class="tips">-w</span>参数来引导certbot找到web服务的根目录</p>
<pre><code>certbot certonly --webroot -w 网站根目录 -d 域名</code></pre>
<p>如：Nginx默认放置网页的根目录为：<span class="tips">/usr/local/nginx/html</span>，则对应命令为</p>
<div class="show"><code>certbot certonly --webroot -w /usr/local/nginx/html -d shiwivi.com</code></div>


<h5 id="3-Standalone模式"><a href="#3-Standalone模式" class="headerlink" title="3. Standalone模式"></a>3. Standalone模式</h5><p>如果服务器上没有部署任何web服务，或者不想使用已部署的服务，则可以使用Standalone模式，该模式下，certbot 会自动运行一个 web server 来进行验证。该服务需要占用<span class="tips">80</span>端口，如果我们自己的服务器上已经有 web server 正在运行 （如 Nginx 或 Apache ）并且占用了80端口，则使用Standalone前应该关闭相关服务或修改端口。</p>
<pre><code>certbot certonly --standalone -d 域名</code></pre>
<p>可以在命令中指定验证的端口和协议</p>
<div class="show"><code>certbot certonly --standalone --&lt;challenge-type>-address  -d 域名</code></div>

<div class="broadcast color-purple">
<div class="iconfont icon-fengche"></div>
更多验证方法详见官方文档：<a target="_blank" rel="noopener" href="https://eff-certbot.readthedocs.io/en/stable/">https://eff-certbot.readthedocs.io/en/stable/</a></div>

<h4 id="申请流程"><a href="#申请流程" class="headerlink" title="申请流程"></a>申请流程</h4><p>certbot完成认证后会开始进入申请流程，初次申请证书，可能需要经历以下流程：</p>
<ul>
<li>certbot会提示你阅读并同意使用者条款</li>
<li>让你输入一个email地址以推送消息，在证书快到期时，lets encrypt会发邮件提醒你及时更新证书</li>
<li>询问是否愿意将该邮箱提供给EFF，他们会推送有关lets encrypt 的资讯</li>
</ul>
<p>邮箱的添加可以在一开始使用<span class="tips"></span></p>
<p>证书申请成功后，certbot会返回如下提示信息，其中较为重要的信息包括证书与密钥路径，证书到期时间</p>
<div class="shell">IMPORTANT NOTES:
 - Congratulations! Your certificate and chain have been saved at:
   /etc/letsencrypt/live/newyear1234.xyz/fullchain.pem
   Your key file has been saved at:
   /etc/letsencrypt/live/newyear1234.xyz/privkey.pem
   Your certificate will expire on 2022-10-27. To obtain a new or
   tweaked version of this certificate in the future, simply run
   certbot again. To non-interactively renew *all* of your
   certificates, run "certbot renew"
 - If you like Certbot, please consider supporting our work by:

<p>   Donating to ISRG / Let’s Encrypt:   <a target="_blank" rel="noopener" href="https://letsencrypt.org/donate">https://letsencrypt.org/donate</a><br>   Donating to EFF:                    <a target="_blank" rel="noopener" href="https://eff.org/donate-le">https://eff.org/donate-le</a></div></p>
<h4 id="插件未安装报错问题"><a href="#插件未安装报错问题" class="headerlink" title="插件未安装报错问题"></a>插件未安装报错问题</h4><p>以nginx为例，执行<span class="tips">sudo certbot -&zwnj;-nginx</span>时，可能会有nginx插件未被正确安装报错</p>
<div class="shell">The requested nginx plugin does not appear to be installed</div>

<p>安装nginx插件</p>
<pre><code>yum install python-certbot-nginx</code></pre>

<p>问题叠问题，如果源中没有该插件包，又可能会遇到报错提示无有效的包</p>
<div class="shell">No package python-certbot-nginx available.
Error: Nothing to do</div>

<p>此时需要更换一下repo 源，更换前记得先将自己的源的备份</p>
<pre><code>yum remove -y epel-release  # 先移除当前的包</code></pre>
<pre><code>yum clean all -v     # 清除所有下载缓存的包，并显示过程</code></pre>
<pre><code>yum makecache        # 重新将远程服务器的包下载缓存到本地</code></pre>
<pre><code>yum install -y epel-release # 重新安装 epel </code></pre>

<p>安装完epel，再重新尝试安装插件，安装完成就可以开始申请证书了</p>
<pre><code>yum install python-certbot-nginx</code></pre>

<h4 id="web服务无法找到报错问题"><a href="#web服务无法找到报错问题" class="headerlink" title="web服务无法找到报错问题"></a>web服务无法找到报错问题</h4><p>执行<span class="tips">sudo certbot -&zwnj;-nginx</span>时，还可能会遇到 certbot 无法找到 web server 或配置文件报错，这是路径问题，可以建一个软链接到 /etc/nginx 目录下</p>
<pre><code>ln -s /usr/local/nginx/conf/ /etc/nginx</code></pre>
<p>或者在申请证书时手动指定nginx配置文件路径</p>
<pre><code>certbot --nginx-server-root /usr/local/nginx/conf</code></pre>

<h3 id="文件说明"><a href="#文件说明" class="headerlink" title="文件说明"></a>文件说明</h3><p>证书申请成功后，相关文件会放置在<span class="tips">/etc/letsencrypt</span>目录下，一般就用得到证书和密钥文件</p>
<h4 id="密钥与证书"><a href="#密钥与证书" class="headerlink" title="密钥与证书"></a>密钥与证书</h4><p>证书和密钥位于 <span class="tips">/etc/letsencrypt/live/域名.xx/</span> 路径下，该路径下有如下几个文件（配置时一般只需要fullchain.pem和privkey.pem文件）：</p>
<ul>
<li><span class="strong">fullchain.pem：</span>完整的证书链文件，包含了cert.pem和chain.pem文件中的内容</li>
<li><span class="strong">privkey.pem：</span>证书对应的私钥</li>
<li>cert.pem：证书文件，需要与chain.pem文件结合使用</li>
<li>chain.pem：链文件，包含了浏览器解析所需的其他全部证书，比如根证书和中间证书</li>
<li>README：说明文件</li>
</ul>
<h4 id="通用配置文件"><a href="#通用配置文件" class="headerlink" title="通用配置文件"></a>通用配置文件</h4><p>在<span class="tips">/etc/letsencrypt</span>路径下会生成Nginx的通用配置文件<span class="tips">options-ssl-nginx.conf</span></p>
<div class="shell">ssl_session_cache shared:le_nginx_SSL:10m;
ssl_session_timeout 1440m;

<p>ssl_protocols TLSv1.2;<br>ssl_prefer_server_ciphers off;</p>
<p>ssl_ciphers “FCDHE-FCLSA….”;</div></p>
<ul>
<li>ssl_session_cache：会话缓存</li>
<li>ssl_session_timeout：用户会话缓存失效时间，如果对安全性有较高要求，可以降低此值</li>
<li>ssl_protocols：加密协议</li>
<li>ssl_prefer_server_ciphers：是否开启服务端加密算法优先</li>
<li>ssl_ciphers：加密算法列表</li>
</ul>
<h4 id="密钥交换"><a href="#密钥交换" class="headerlink" title="密钥交换"></a>密钥交换</h4><p>在<span class="tips">/etc/letsencrypt</span>路径下还有一个用于密钥交换算法的Diffie-Hellman 密钥<span class="tips">ssl-dhparams.pem</span></p>
<h4 id="历史文件"><a href="#历史文件" class="headerlink" title="历史文件"></a>历史文件</h4><p><span class="tips">/etc/letsencrypt/archive</span>和<span class="tips">/etc/letsencrypt/keys</span>包含所有以前的密钥和证书，而<span class="tips">/etc/letsencrypt/live</span>目录下保存了最新的证书和密钥</p>
<h4 id="日志文件"><a href="#日志文件" class="headerlink" title="日志文件"></a>日志文件</h4><p>默认情况下，certbot 的日志文件位于/var/log/letsencrypt 路径下。且默认情况下，一旦日志目录中有 1000 条日志，certbot 就会开始日志轮替。</p>
<h3 id="Nginx配置文件"><a href="#Nginx配置文件" class="headerlink" title="Nginx配置文件"></a>Nginx配置文件</h3><div class="show">server {
listen 443 ssl;

<p>#配置SSL证书和密钥路径<br>ssl_certificate    /etc/letsencrypt/live/域名/fullchain.pem;<br>ssl_certificate_key    /etc/letsencrypt/live/域名/privkey.pem;</p>
<p>#可以将certbot生成的通用配置文件包含进去，自由选择<br>include    /etc/letsencrypt/options-ssl-nginx.conf;</p>
<p>#使用生成的Diffie-Hellman 密钥，自由选择<br>ssl_dhparam    /etc/letsencrypt/ssl-dhparams.pem;<br>……<br>}</div></p>
<div class="broadcast color-pink">
<div class="iconfont icon-yinle1"></div>
Diffie-Hellman密钥用于密钥交换</div>


<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><h4 id="测试自动续订"><a href="#测试自动续订" class="headerlink" title="测试自动续订"></a>测试自动续订</h4><ul>
<li><span class="strong">sudo certbot renew -&zwnj;-dry-run</span> 测试更新证书</li>
</ul>
<p>如果测试成功，certbot会返回成功信息</p>
<div class="shell">- - - - -
Account registered.
Simulating renewal of an existing certificate for newyear110.xyz
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Congratulations, all simulated renewals succeeded: 
  /etc/letsencrypt/live/newyear110.xyz/fullchain.pem (success)
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - </div>

<h5 id="插件未安装报错"><a href="#插件未安装报错" class="headerlink" title="插件未安装报错"></a>插件未安装报错</h5><p>在测试续订时，如果遇到插件未安装的报错，则需要安装nginx插件</p>
<div class="shell">Failed to renew certificate newyear110.xyz with error: 
The requested nginx plugin does not appear to be installed</div>

<p>安装<span class="tips">letsencrypt-nginx</span>插件</p>
<pre><code>pip3 install -U letsencrypt-nginx</code></pre>

<div class="broadcast color-blue">
<div class="iconfont icon-yinhao"></div>
更多关于插件未安装的报错，可以查看github上的Issues，上述解决方法也来源于该贴：<a target="_blank" rel="noopener" href="https://github.com/certbot/certbot/issues/1736">https://github.com/certbot/certbot/issues/1736</a></div>

<h4 id="续订证书"><a href="#续订证书" class="headerlink" title="续订证书"></a>续订证书</h4><ul>
<li><span class="strong">certbot renew</span> 自动更新30天内到期的证书（推荐）</li>
<li><span class="strong">certbot renew -&zwnj;-force-renewal</span> 强制更新未到期的证书</li>
</ul>
<p>在初次申请证书时，certbot会记住所使用的配置和插件，并在续订时使用相同的配置和插件。如果需要更改配置（如：修改文件路径），则需要以下步骤</p>
<ol>
<li>在命令行中使用修改以后的配置进行一次测试自动续订</li>
<li>测试成功，说明新的配置是可以运行的，再执行一次证书更新（时间未到就使用强制更新），这将保存新的配置</li>
</ol>
<div class="broadcast color-red">
<div class="iconfont icon-gantanhao"></div>
CA机构会限制证书颁发速度并阻止用户在短时间内多次续订同一个域名的证书，所以不要在短时间内多次执行强制更新证书操作</div>





<h4 id="查看证书列表"><a href="#查看证书列表" class="headerlink" title="查看证书列表"></a>查看证书列表</h4><ul>
<li><span class="strong">certbot certificates</span> 查看证书</li>
</ul>
<p>会返回当前所有域名的证书情况，包括证书名、 证书序列号、密钥类型、到期时间、证书路径、私钥路径信息</p>
<div class="show">Found the following certs:
  Certificate Name: newyear110.xyz
    Serial Number: 34829c6e3465f2b1b90db11c36111480280
    Key Type: RSA
    Domains: newyear110.xyz
    Expiry Date: 2022-10-27 11:47:25+00:00 (VALID: 87 days)
    Certificate Path: /etc/letsencrypt/live/newyear110.xyz/fullchain.pem
    Private Key Path: /etc/letsencrypt/live/newyear110.xyz/privkey.pem
</div>

<h4 id="吊销与删除证书"><a href="#吊销与删除证书" class="headerlink" title="吊销与删除证书"></a>吊销与删除证书</h4><p>删除与吊销证书前，应当从web服务器软件的配置文件中删除对对应证书的引用</p>
<ul>
<li><span class="strong">certbot revoke -&zwnj;-cert-name 域名.xxx</span> 吊销证书(根据域名)</li>
<li><span class="strong">certbot revoke -&zwnj;-cert-path /etc/letsencrypt/live/域名.xxx/cert.pem</span> 吊销证书(根据路径)</li>
<li><span class="strong">certbot delete -&zwnj;-cert-name 域名.xxx</span> 删除指定证书</li>
<li><span class="strong">certbot delete</span> 从列表中选择删除证书</li>
</ul>
<div class="broadcast color-blue">
<div class="iconfont icon-yinhao"></div>
官方命令和文档：<a target="_blank" rel="noopener" href="https://eff-certbot.readthedocs.io/en/stable/using.html">https://eff-certbot.readthedocs.io/en/stable/using.html</a></div>

        </div>
    </div>
    <div class="post-nav">
        
            <div class="post-prev ">
                <a href="/blog/2022/09/18/History-of-browser/">上一篇：Web的发展旅程</a>
            </div>
            
            
                <div class="post-next">
                    <a href="/blog/2022/07/16/%E8%B7%AF%E7%94%B1%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%AE%88%E5%8D%AB/">下一篇：路由与路由守卫 </a>
                </div>
                 
    </div>
    <div class="container">
        <!--设计来源于B站-季夏小贞-->
        <div class="big-head"></div>
        <div class="ears"></div>
        <div class="body"></div>
        <div class="paws-front"></div>
        <div class="paws-back"></div>
        <div class="details"></div>
        <div class="tail"></div>
        <div class="sleep">
          <span class="s1">z</span>
          <span class="s2">z</span>
          <span class="s3">z</span>
          <span class="s4">z</span>
          <span class="s5">z</span>
        </div>
    </div>
</div>
<div class="right-menu">
    <a class="iconfont back-top" href="javascript:">&#xe655;</a>
    <div class="husky"></div>
  </div>
</div>

<script src="/blog/js/jquery.min.js"></script>
<script src="/blog/js/jquery.bumpytext.js"></script>
<script src="/blog/js/index.js"></script>
<script src="/blog/js/highlight.min.js"></script>
<script src="/blog/js/highlightjs-line-numbers.min.js"></script>
<script src="/blog/js/article.js"></script>

</body></html>